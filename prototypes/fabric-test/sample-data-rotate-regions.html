<!doctype html>
<html lang="en-US" class=" fonts-loaded ">
<head>
<title></title>
<script src="http://cdnjs.cloudflare.com/ajax/libs/fabric.js/1.7.3/fabric.min.js"></script>
<link rel="stylesheet" type="text/css" href="styles.css">
<script src="loader.js"></script>
</head>
<body>
  <header>
    <a href="">Annotator</a>
    <nav>
      <a href="index.html">demographic</a>
      <a href="region-annotation.html">regions</a>
      <a>landmarks</a>
    </nav>
  </header>
  <canvas id="c" width="500" height="500"></canvas>

  <script>
  (function() {
    /* template:
    {
      name: "",
      perceivedGender: "",
      age: ,
      perceivedEthnicity: "",
      imgUri: "",
      landmarks: []
    }

    imgUri prefix: http://www.code4rights.com/

    landmarks key:
    left-eye-x  left-eye-y
    right-eye-x  right-eye-x
    nose-x  nose-y
    left-mouth-corner-x   left-mouth-corner-y
    right-mouth-corner-x right-mouth-corner-y

    */
    loader('../../test/sample-data.json', function( response ){

      console.log(response)

      // response.data.forEach(function(face){
      //   consol.log(face)
      // })

      function getRandomColor() {
        var letters = '0123456789ABCDEF';
        var color = '#';
        for (var i = 0; i < 6; i++ ) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
      }


      var canvas = foo = this.__canvas = new fabric.Canvas('c');

      fabric.Object.prototype.transparentCorners = false;
      fabric.Object.prototype.originX = fabric.Object.prototype.originY = 'center';

      var cnt = 0;

      var rotateFaces = setInterval(function(){
        var faceObj = response.data[cnt];
        while(faceObj && !faceObj.landmarks[0]) {
          cnt++;
          faceObj = response.data[cnt];
        }
        if(!faceObj){
          clearInterval(rotateFaces);
          return
        }
        var landmarks = faceObj.landmarks;

        var pts = {
          leftEye: {x: landmarks[0], y: landmarks[1]},
          rightEye: {x: landmarks[2], y: landmarks[3]},
          nose: {x: landmarks[4], y: landmarks[5]},
          leftMouth: {x: landmarks[6], y: landmarks[7]},
          rightMouth: {x: landmarks[8], y: landmarks[9]},
        };
        console.log('eye y diff', Math.abs(pts.leftEye.y - pts.rightEye.y))
        console.log('mouth y diff', Math.abs(pts.leftMouth.y - pts.rightMouth.y))

        var faceImg = 'http://www.code4rights.com/' + faceObj.imgUri;
        canvas.clear()
        canvas.setBackgroundImage(faceImg, canvas.renderAll.bind(canvas), {
          originX: 'left',
          originY: 'top',
          left: 0,
          top: 0,
          width: 250,
          height: 250,
        });

        canvas.add(
          makeCircle(pts.leftEye.x, pts.leftEye.y, null, '#BADA55')
        );
        canvas.add(
          makeCircle(pts.rightEye.x, pts.rightEye.y, null, '#BADA55')
        );
        canvas.add(
          makeCircle(pts.nose.x, pts.nose.y, null, '#ABCDEF')
        );
        canvas.add(
          makeCircle(pts.leftMouth.x, pts.leftMouth.y, null, '#ff9999')
        );
        canvas.add(
          makeCircle(pts.rightMouth.x, pts.rightMouth.y, null, '#ff9999')
        );
        cnt+=1;

      }, 1500)

      function makeCircle(left, top, id, color) {
        var c = new fabric.Circle({
          left: left,
          top: top,
          strokeWidth: 1,
          radius: 8,
          fill: color || '#33a',
          uniqId: id
        });
        c.hasControls = c.hasBorders = false;
        return c;
      }

    });
  })();
</script>

</body>
</html>
